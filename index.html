<!doctype html>
<head>
  <meta charset="utf-8">
  <title>TrackML event explorer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.4.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>  
  <script src="third_party/OrbitControls.js"></script>
  <script src="primitives.js"></script>
  <script src="app.js"></script>
  <script src="vm.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">  
</head>
<body>
  <div id="container"></div>
  <div id='controls' class="hover-panel">    
    <p><input type='checkbox' data-bind='checked: Autorotate'/>Autorotate</p>    
    <hr>
    <p><input type="checkbox" data-bind="checked: ShowHits"/>Show hits</p>
    <p><input type="checkbox" data-bind="checked: ShowOrigins"/>Show particle origin vectors<br/>blue - negative particle sharge<br/> red - positive particel charge</p>    
    <p>Particle idx to show (0 = noise):<br/><input data-bind='textInput: FilterParticleIdx'/></p>
    <p>Velocity len multiplier:<input data-bind="textInput: VelocityLenMultiplier"/></p>
    
  </div>
  <div id='status' class="hover-panel">
    <h3>event 000001000</h3>
    <p>Overall particles: <span data-bind="text: ParticlesCount"></span></p>
    <p>Overall hits: <span data-bind="text: HitsCount"></span></p>    
    <p>Shown hits: <span data-bind="text: ShownHits().length"></span></p>
  </div>
  <script>
      var vm = new ViewModel();            

      init();
      ko.applyBindings(vm);

      vm.Autorotate(true);
      vm.ShowHits(true);
      vm.ShowOrigins(true);
      vm.VelocityLenMultiplier(0.1);

      run();

      
      
      Papa.parse("event000001000-hits.csv", {
	    download: true,
	    complete: function(results) {
          //hit_id,x,y,z,volume_id,layer_id,module_id
          var N = results.data.length - 1;          
          var points = [];
          var hitMap = {};
          for(var i=0;i<N;i++) {
              var row = results.data[i+1];
              points.push(new THREE.Vector3(parseFloat(row[1]),parseFloat(row[2]),parseFloat(row[3])));                       	            
              hitMap[parseInt(row[0])] = i;
            }	
          vm.Hits(points);          
          vm.HitsMap(hitMap);
	        }
      });

      Papa.parse("event000001000-truth.csv", {
	    download: true,
	    complete: function(results) {
        //hit_id,particle_id,tx,ty,tz,tpx,tpy,tpz,weight
        var N = results.data.length - 1;
        var truths = [];
        for(var i=0;i<N;i++) {
          var row = results.data[i+1];
          truths.push(new Truth(
            parseInt(row[0]),
            parseInt(row[1]),
            parseFloat(row[2]),
            parseFloat(row[3]),
            parseFloat(row[4]),
            parseFloat(row[5]),
            parseFloat(row[6]),
            parseFloat(row[7]),
            parseFloat(row[8]),
          ));
        }
        vm.Truths(truths);
      }
      });

      Papa.parse("event000001000-particles.csv", {
	    download: true,
	    complete: function(results) {
        // particle_id,vx,vy,vz,px,py,pz,q,nhits
        var N = results.data.length - 1;
        var particles = [];
        var map = {};
        for(var i=0;i<N;i++) {
          var row = results.data[i+1];
          var particle_id = parseInt(row[0]);
          var particle = new Particle(
            particle_id,
            parseFloat(row[1]),
            parseFloat(row[2]),
            parseFloat(row[3]),
            parseFloat(row[4]),
            parseFloat(row[5]),
            parseFloat(row[6]),
            parseInt(row[7]),
            parseInt(row[8])
          );
          map[particle_id] = particle;
          particles.push(particle);
        }
        vm.ParticleMap(map);
        vm.Particles(particles);
      }
      });
  </script>
</body>
</html>